name: CD

on:
  workflow_run:
    workflows: [ "CI" ]           # ‚Üê –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å name: –≤ ci.yml
    branches:  [ main ]
    types:     [ completed ]

jobs:
  deploy-prod:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env.prod from secrets
        run: |
          cat <<EOF > .env.prod
          BOT_TOKEN_PROD=${{ secrets.BOT_TOKEN_PROD }}
          ENV=prod
          # –¥–æ–±–∞–≤—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
          EOF

      - name: Pull and restart container
        run: |
          docker pull docker.io/${{ secrets.DOCKERHUB_USERNAME }}/linux-quiz-bot:latest
          docker compose -f docker-compose.prod.yml \
                         --env-file .env.prod \
                         up -d --force-recreate

      - name: Smoke test ‚Äì ping bot
        run: |
          sleep 5
          curl -sf "http://localhost:8080/healthz" || echo "ü§∑‚Äç‚ôÄÔ∏è no health-check yet"
