---
- name: Deploy linux-quiz-bot
  hosts: prod
  become: true

  vars:
    image_name: "shuratsyganok/linux-quiz-bot"
    image_tag: "{{ lookup('env', 'IMAGE_TAG') | default('latest') }}"
    project_dir: "/home/sasha/apps/linux-quiz-bot"

  tasks:
    - name: Ensure Docker & docker-compose installed
      import_role:
        name: geerlingguy.docker

    - name: Pull requested image
      community.docker.docker_image:
        name: "{{ image_name }}"
        tag: "{{ image_tag }}"
        source: pull

    - name: Copy compose file & env
      template:
        src: templates/docker-compose.prod.yml.j2
        dest: "{{ project_dir }}/docker-compose.yml"
        owner: sasha
        mode: '0644'

    - name: Up via compose
      community.docker.docker_compose:
        project_src: "{{ project_dir }}"
        state: present
        pull: false
        recreate: true
